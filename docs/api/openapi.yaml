openapi: 3.0.3
info:
  title: Right-Sizer Operator API
  description: |
    The Right-Sizer Operator API provides endpoints for monitoring, configuration, and management
    of Kubernetes pod resource optimization. This API enables real-time metrics access, optimization
    event tracking, and health monitoring of the Right-Sizer operator.
  version: 0.1.15
  contact:
    name: Right-Sizer Contributors
    email: maintainers@right-sizer.dev
    url: https://github.com/aavishay/right-sizer
  license:
    name: AGPL-3.0-or-later
    url: https://www.gnu.org/licenses/agpl-3.0.html

servers:
  - url: http://right-sizer.right-sizer.svc.cluster.local:8081
    description: In-cluster service endpoint
  - url: http://localhost:8081
    description: Local development server
  - url: https://right-sizer.example.com
    description: Production endpoint (when exposed via ingress)

tags:
  - name: Health
    description: Health check and readiness endpoints
  - name: Metrics
    description: Prometheus-compatible metrics endpoints
  - name: Events
    description: Optimization event management
  - name: Configuration
    description: Runtime configuration endpoints
  - name: Webhooks
    description: Admission webhook endpoints

paths:
  /healthz:
    get:
      tags:
        - Health
      summary: Liveness probe endpoint
      description: Returns the health status of the operator. Used by Kubernetes liveness probes.
      operationId: getLiveness
      responses:
        '200':
          description: Operator is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
        '503':
          description: Operator is unhealthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /readyz:
    get:
      tags:
        - Health
      summary: Readiness probe endpoint
      description: Returns the readiness status of the operator. Used by Kubernetes readiness probes.
      operationId: getReadiness
      responses:
        '200':
          description: Operator is ready
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReadinessResponse'
        '503':
          description: Operator is not ready
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReadinessResponse'

  /metrics:
    get:
      tags:
        - Metrics
      summary: Prometheus metrics endpoint
      description: |
        Returns Prometheus-formatted metrics about the operator's performance and resource optimization activities.

        Available metrics include:
        - `rightsizer_pods_processed_total` - Total number of pods processed
        - `rightsizer_pods_resized_total` - Total number of pods resized
        - `rightsizer_cpu_adjustments_total` - CPU resource adjustments
        - `rightsizer_memory_adjustments_total` - Memory resource adjustments
        - `rightsizer_resource_change_percentage` - Resource change distributions
        - `rightsizer_processing_duration_seconds` - Processing time metrics
        - `rightsizer_errors_total` - Error counts by type
      operationId: getMetrics
      responses:
        '200':
          description: Prometheus metrics
          content:
            text/plain:
              schema:
                type: string
                example: |
                  # HELP rightsizer_pods_processed_total Total number of pods processed
                  # TYPE rightsizer_pods_processed_total counter
                  rightsizer_pods_processed_total{namespace="default"} 1234

                  # HELP rightsizer_pods_resized_total Total number of pods resized
                  # TYPE rightsizer_pods_resized_total counter
                  rightsizer_pods_resized_total{namespace="default",resource="cpu"} 456

  /api/v1/events:
    get:
      tags:
        - Events
      summary: List optimization events
      description: Returns a list of optimization events with optional filtering
      operationId: listOptimizationEvents
      parameters:
        - name: namespace
          in: query
          description: Filter events by namespace
          schema:
            type: string
            example: default
        - name: workload
          in: query
          description: Filter events by workload name
          schema:
            type: string
            example: nginx-deployment
        - name: status
          in: query
          description: Filter events by status
          schema:
            type: string
            enum: [completed, pending, failed]
        - name: since
          in: query
          description: Return events since this timestamp (RFC3339)
          schema:
            type: string
            format: date-time
        - name: limit
          in: query
          description: Maximum number of events to return
          schema:
            type: integer
            minimum: 1
            maximum: 1000
            default: 100
      responses:
        '200':
          description: List of optimization events
          content:
            application/json:
              schema:
                type: object
                properties:
                  events:
                    type: array
                    items:
                      $ref: '#/components/schemas/OptimizationEvent'
                  total:
                    type: integer
                    description: Total number of events matching the filter
                  next:
                    type: string
                    description: Token for pagination

    post:
      tags:
        - Events
      summary: Create optimization event
      description: Creates a new optimization event (internal use)
      operationId: createOptimizationEvent
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OptimizationEventRequest'
      responses:
        '201':
          description: Event created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OptimizationEvent'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/events/{eventId}:
    get:
      tags:
        - Events
      summary: Get optimization event by ID
      description: Returns details of a specific optimization event
      operationId: getOptimizationEvent
      parameters:
        - name: eventId
          in: path
          required: true
          description: Event ID
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Event details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OptimizationEvent'
        '404':
          description: Event not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/config:
    get:
      tags:
        - Configuration
      summary: Get current configuration
      description: Returns the current runtime configuration of the operator
      operationId: getConfiguration
      responses:
        '200':
          description: Current configuration
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Configuration'

    patch:
      tags:
        - Configuration
      summary: Update configuration
      description: Updates runtime configuration (limited set of fields)
      operationId: updateConfiguration
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ConfigurationUpdate'
      responses:
        '200':
          description: Configuration updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Configuration'
        '400':
          description: Invalid configuration
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/statistics:
    get:
      tags:
        - Metrics
      summary: Get optimization statistics
      description: Returns aggregated statistics about resource optimization
      operationId: getStatistics
      parameters:
        - name: period
          in: query
          description: Time period for statistics
          schema:
            type: string
            enum: [1h, 6h, 24h, 7d, 30d]
            default: 24h
      responses:
        '200':
          description: Optimization statistics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Statistics'

  /validate:
    post:
      tags:
        - Webhooks
      summary: Validating admission webhook
      description: Validates pod resource specifications
      operationId: validateAdmission
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AdmissionReview'
      responses:
        '200':
          description: Admission review response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdmissionReview'

  /mutate:
    post:
      tags:
        - Webhooks
      summary: Mutating admission webhook
      description: Mutates pod resource specifications based on optimization policies
      operationId: mutateAdmission
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AdmissionReview'
      responses:
        '200':
          description: Admission review response with mutations
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdmissionReview'

components:
  schemas:
    HealthResponse:
      type: object
      required:
        - status
        - timestamp
      properties:
        status:
          type: string
          enum: [healthy, unhealthy]
          description: Health status
        timestamp:
          type: string
          format: date-time
          description: Check timestamp
        message:
          type: string
          description: Optional status message
        version:
          type: string
          description: Operator version
          example: "0.1.15"

    ReadinessResponse:
      type: object
      required:
        - ready
        - checks
      properties:
        ready:
          type: boolean
          description: Overall readiness status
        checks:
          type: object
          properties:
            kubernetes:
              type: boolean
              description: Kubernetes API connectivity
            metrics:
              type: boolean
              description: Metrics server availability
            crds:
              type: boolean
              description: CRDs installed and ready
            leader:
              type: boolean
              description: Leader election status (if enabled)
        message:
          type: string
          description: Readiness message

    OptimizationEvent:
      type: object
      required:
        - id
        - timestamp
        - namespace
        - workload
        - resourceType
        - status
      properties:
        id:
          type: string
          format: uuid
          description: Unique event identifier
        timestamp:
          type: string
          format: date-time
          description: Event timestamp
        namespace:
          type: string
          description: Kubernetes namespace
        workload:
          type: string
          description: Workload name (deployment, statefulset, etc.)
        workloadKind:
          type: string
          enum: [Deployment, StatefulSet, DaemonSet, ReplicaSet]
          description: Type of workload
        podName:
          type: string
          description: Affected pod name
        resourceType:
          type: string
          enum: [cpu, memory, both]
          description: Type of resource adjusted
        previousValue:
          type: object
          properties:
            requests:
              type: string
              description: Previous resource requests
            limits:
              type: string
              description: Previous resource limits
        newValue:
          type: object
          properties:
            requests:
              type: string
              description: New resource requests
            limits:
              type: string
              description: New resource limits
        changePercentage:
          type: number
          format: float
          description: Percentage change in resources
        status:
          type: string
          enum: [completed, pending, failed]
          description: Event status
        reason:
          type: string
          description: Reason for the optimization or failure
        policy:
          type: string
          description: Applied policy name
        dryRun:
          type: boolean
          description: Whether this was a dry-run operation

    OptimizationEventRequest:
      type: object
      required:
        - namespace
        - workload
        - resourceType
        - previousValue
        - newValue
      properties:
        namespace:
          type: string
        workload:
          type: string
        workloadKind:
          type: string
        podName:
          type: string
        resourceType:
          type: string
          enum: [cpu, memory, both]
        previousValue:
          type: object
        newValue:
          type: object
        reason:
          type: string
        policy:
          type: string
        dryRun:
          type: boolean

    Configuration:
      type: object
      properties:
        enabled:
          type: boolean
          description: Whether optimization is enabled
        mode:
          type: string
          enum: [aggressive, balanced, conservative, custom]
          description: Optimization mode
        dryRun:
          type: boolean
          description: Dry-run mode
        resizeInterval:
          type: string
          description: Resize check interval (e.g., "5m")
        namespaces:
          type: object
          properties:
            included:
              type: array
              items:
                type: string
              description: Included namespaces
            excluded:
              type: array
              items:
                type: string
              description: Excluded namespaces
        resourceStrategy:
          type: object
          properties:
            cpu:
              $ref: '#/components/schemas/ResourceStrategy'
            memory:
              $ref: '#/components/schemas/ResourceStrategy'
        constraints:
          $ref: '#/components/schemas/Constraints'

    ConfigurationUpdate:
      type: object
      properties:
        enabled:
          type: boolean
        mode:
          type: string
          enum: [aggressive, balanced, conservative, custom]
        dryRun:
          type: boolean
        resizeInterval:
          type: string

    ResourceStrategy:
      type: object
      properties:
        requestMultiplier:
          type: number
          format: float
          minimum: 0.1
          maximum: 2.0
        limitMultiplier:
          type: number
          format: float
          minimum: 1.0
          maximum: 5.0
        minRequest:
          type: string
          description: Minimum resource request (e.g., "10m", "64Mi")
        maxLimit:
          type: string
          description: Maximum resource limit
        targetUtilization:
          type: number
          format: float
          minimum: 0
          maximum: 100
        scaleUpThreshold:
          type: number
          format: float
        scaleDownThreshold:
          type: number
          format: float

    Constraints:
      type: object
      properties:
        maxChangePercentage:
          type: number
          format: float
          description: Maximum percentage change per adjustment
        minChangeThreshold:
          type: string
          description: Minimum absolute change required
        cooldownPeriod:
          type: string
          description: Cooldown period between adjustments
        maxConcurrentResizes:
          type: integer
          description: Maximum concurrent resize operations
        preventOOMKill:
          type: boolean
          description: Prevent adjustments that might cause OOM
        respectPodDisruptionBudget:
          type: boolean
          description: Respect PDB during adjustments

    Statistics:
      type: object
      properties:
        period:
          type: string
          description: Statistics period
        totalPodsProcessed:
          type: integer
          description: Total pods processed
        totalPodsResized:
          type: integer
          description: Total pods resized
        totalOptimizations:
          type: integer
          description: Total optimization operations
        successfulOptimizations:
          type: integer
          description: Successful optimizations
        failedOptimizations:
          type: integer
          description: Failed optimizations
        resourceSavings:
          type: object
          properties:
            cpu:
              type: object
              properties:
                totalSaved:
                  type: string
                  description: Total CPU saved (e.g., "2000m")
                percentageSaved:
                  type: number
                  format: float
            memory:
              type: object
              properties:
                totalSaved:
                  type: string
                  description: Total memory saved (e.g., "4Gi")
                percentageSaved:
                  type: number
                  format: float
        topOptimizedWorkloads:
          type: array
          items:
            type: object
            properties:
              namespace:
                type: string
              workload:
                type: string
              savingsPercentage:
                type: number
                format: float

    Error:
      type: object
      required:
        - code
        - message
      properties:
        code:
          type: string
          description: Error code
        message:
          type: string
          description: Error message
        details:
          type: object
          description: Additional error details

    AdmissionReview:
      type: object
      description: Kubernetes admission review object
      properties:
        apiVersion:
          type: string
          example: admission.k8s.io/v1
        kind:
          type: string
          example: AdmissionReview
        request:
          type: object
          description: Admission request
        response:
          type: object
          description: Admission response

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token for API authentication

security: []
