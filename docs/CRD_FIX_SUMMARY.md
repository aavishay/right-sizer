# CRD Field Validation Fix - Summary of Changes

## Problem Fixed
Fixed "unknown field" warnings in right-sizer pod logs that were caused by using simplified CRD definitions with `x-kubernetes-preserve-unknown-fields: true` instead of properly structured field schemas.

## Files Removed
The following files were removed as they contained simplified CRD definitions that caused the validation issues:

1. `/helm/crds/rightsizerconfig.yaml` - Simplified RightSizerConfig CRD
2. `/helm/crds/rightsizerpolicy.yaml` - Simplified RightSizerPolicy CRD  
3. `/helm/crds/rightsizer-crds.yaml` - Combined simplified CRDs file

These files used `x-kubernetes-preserve-unknown-fields: true` which prevented proper field validation.

## Files Retained (Correct CRDs)
The following files contain the correct, fully-defined CRD schemas and should be used:

1. `/helm/crds/rightsizer.io_rightsizerconfigs.yaml` - Full RightSizerConfig CRD with complete field definitions
2. `/helm/crds/rightsizer.io_rightsizerpolicies.yaml` - Full RightSizerPolicy CRD with complete field definitions

These files were generated by controller-gen and include proper OpenAPI v3 schemas for all fields.

## Scripts Created/Updated

### New Scripts
1. **`/scripts/fix-crd-fields.sh`** - Automated script to fix CRD issues
   - Backs up existing CRDs and resources
   - Replaces simplified CRDs with full versions
   - Restarts the operator
   - Verifies the fix

### Updated Scripts
1. **`/scripts/install-crds.sh`** - Updated to install the correct CRD files
   - Changed from using single combined file to individual CRD files
   - Now installs `rightsizer.io_rightsizerconfigs.yaml` and `rightsizer.io_rightsizerpolicies.yaml`

2. **`/tests/integration/test-crd-config.sh`** - Updated to use correct CRD files
   - Changed from applying entire directory to specific files

## Documentation Updates

### New Documentation
1. **`/docs/TROUBLESHOOTING_CRD_FIELDS.md`** - Comprehensive troubleshooting guide
   - Explains the root cause
   - Provides quick fix methods
   - Includes prevention strategies
   - Details verification steps

### Updated Documentation
1. **`/README.md`** - Added CRD field validation troubleshooting section
   - Quick reference to fix script
   - Link to detailed troubleshooting guide

2. **`/CONFIGURATION-CRD.md`** - Updated installation instructions
   - Changed from referencing combined CRD file to individual files

## How to Apply the Fix

### For Existing Installations
```bash
# Option 1: Use the automated fix script
./scripts/fix-crd-fields.sh

# Option 2: Manually apply correct CRDs
kubectl apply -f helm/crds/rightsizer.io_rightsizerconfigs.yaml
kubectl apply -f helm/crds/rightsizer.io_rightsizerpolicies.yaml

# Then restart the operator
kubectl rollout restart deployment/right-sizer -n right-sizer-system
```

### For New Installations
```bash
# Use the updated install script
./scripts/install-crds.sh

# Or with Helm (which will use the correct CRDs)
helm install right-sizer ./helm --namespace right-sizer-system --create-namespace
```

## Verification
After applying the fix, verify success by:

1. **Check operator logs** - Should no longer show "unknown field" warnings:
   ```bash
   kubectl logs -n right-sizer-system -l app.kubernetes.io/name=right-sizer --tail=100 | grep -i "unknown field"
   ```

2. **Verify CRD schema** - Should not contain `x-kubernetes-preserve-unknown-fields`:
   ```bash
   kubectl get crd rightsizerconfigs.rightsizer.io -o yaml | grep "x-kubernetes-preserve-unknown-fields"
   ```

3. **Test field access** - Should properly explain fields:
   ```bash
   kubectl explain rightsizerconfig.spec.defaultResourceStrategy
   kubectl explain rightsizerconfig.spec.globalConstraints
   ```

## Impact
This fix ensures:
- Clean operator logs without validation warnings
- Proper field validation for CRDs
- Better schema documentation via `kubectl explain`
- Consistent behavior across all installations
- Future compatibility with strict validation requirements

## Rollback
If needed, backups are automatically created by the fix script in `/tmp/right-sizer-crd-backup-[timestamp]/`
