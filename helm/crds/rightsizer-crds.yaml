# Right Sizer Custom Resource Definitions
# These CRDs must be installed before deploying the Right Sizer operator

---
# RightSizerPolicy CRD - Defines resource sizing policies
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: rightsizerpolicies.rightsizer.io
  annotations:
    controller-gen.kubebuilder.io/version: v0.14.0
spec:
  group: rightsizer.io
  versions:
    - name: v1alpha1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          description: RightSizerPolicy defines a resource sizing policy for the Right Sizer operator
          properties:
            apiVersion:
              type: string
              description: 'APIVersion defines the versioned schema of this representation of an object'
            kind:
              type: string
              description: 'Kind is a string value representing the REST resource this object represents'
            metadata:
              type: object
            spec:
              type: object
              description: RightSizerPolicySpec defines the desired state of RightSizerPolicy
              required:
                - priority
                - actions
              properties:
                priority:
                  type: integer
                  minimum: 0
                  maximum: 1000
                  description: Priority of the policy (higher values take precedence)
                enabled:
                  type: boolean
                  default: true
                  description: Whether this policy is enabled
                description:
                  type: string
                  description: Human-readable description of the policy
                selectors:
                  type: object
                  description: Criteria for matching pods
                  properties:
                    namespaces:
                      type: array
                      items:
                        type: string
                      description: List of namespaces to match
                    excludeNamespaces:
                      type: array
                      items:
                        type: string
                      description: List of namespaces to exclude
                    labels:
                      type: object
                      additionalProperties:
                        type: string
                      description: Label selector for pods
                    annotations:
                      type: object
                      additionalProperties:
                        type: string
                      description: Annotation selector for pods
                    workloadTypes:
                      type: array
                      items:
                        type: string
                        enum:
                          - Deployment
                          - StatefulSet
                          - DaemonSet
                          - ReplicaSet
                          - Job
                          - CronJob
                      description: Types of workloads to match
                    containerNames:
                      type: array
                      items:
                        type: string
                      description: Container name patterns to match (supports wildcards)
                    podNameRegex:
                      type: string
                      description: Regular expression for pod names
                    qosClass:
                      type: string
                      enum:
                        - Guaranteed
                        - Burstable
                        - BestEffort
                      description: QoS class of pods to match
                actions:
                  type: object
                  description: Actions to apply when policy matches
                  properties:
                    skip:
                      type: boolean
                      description: Skip resizing for matching pods
                    cpuMultiplier:
                      type: number
                      minimum: 0.1
                      maximum: 10
                      description: Multiplier for CPU resources
                    memoryMultiplier:
                      type: number
                      minimum: 0.1
                      maximum: 10
                      description: Multiplier for memory resources
                    minCPU:
                      type: string
                      pattern: "^[0-9]+(m)?$"
                      description: Minimum CPU request (e.g., 100m, 1)
                    maxCPU:
                      type: string
                      pattern: "^[0-9]+(m)?$"
                      description: Maximum CPU limit (e.g., 4000m, 4)
                    minMemory:
                      type: string
                      pattern: "^[0-9]+(Mi|Gi|Ki)?$"
                      description: Minimum memory request (e.g., 128Mi, 1Gi)
                    maxMemory:
                      type: string
                      pattern: "^[0-9]+(Mi|Gi|Ki)?$"
                      description: Maximum memory limit (e.g., 8Gi, 16Gi)
                    setCPURequest:
                      type: string
                      pattern: "^[0-9]+(m)?$"
                      description: Fixed CPU request value
                    setCPULimit:
                      type: string
                      pattern: "^[0-9]+(m)?$"
                      description: Fixed CPU limit value
                    setMemoryRequest:
                      type: string
                      pattern: "^[0-9]+(Mi|Gi|Ki)?$"
                      description: Fixed memory request value
                    setMemoryLimit:
                      type: string
                      pattern: "^[0-9]+(Mi|Gi|Ki)?$"
                      description: Fixed memory limit value
                schedule:
                  type: object
                  description: Time-based policy activation
                  properties:
                    timeRanges:
                      type: array
                      items:
                        type: object
                        required:
                          - start
                          - end
                        properties:
                          start:
                            type: string
                            pattern: "^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$"
                            description: Start time (HH:MM)
                          end:
                            type: string
                            pattern: "^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$"
                            description: End time (HH:MM)
                    daysOfWeek:
                      type: array
                      items:
                        type: string
                        enum:
                          - Monday
                          - Tuesday
                          - Wednesday
                          - Thursday
                          - Friday
                          - Saturday
                          - Sunday
                    timezone:
                      type: string
                      default: UTC
                      description: Timezone for schedule (e.g., America/New_York, UTC)
            status:
              type: object
              description: RightSizerPolicyStatus defines the observed state of RightSizerPolicy
              properties:
                phase:
                  type: string
                  enum:
                    - Active
                    - Inactive
                    - Error
                  description: Current state of the policy
                lastApplied:
                  type: string
                  format: date-time
                  description: Last time this policy was applied
                matchedPods:
                  type: integer
                  description: Number of pods currently matching this policy
                message:
                  type: string
                  description: Human-readable status message
                conditions:
                  type: array
                  items:
                    type: object
                    required:
                      - type
                      - status
                    properties:
                      type:
                        type: string
                        description: Type of condition
                      status:
                        type: string
                        enum:
                          - "True"
                          - "False"
                          - Unknown
                      lastTransitionTime:
                        type: string
                        format: date-time
                      reason:
                        type: string
                      message:
                        type: string
      subresources:
        status: {}
      additionalPrinterColumns:
        - name: Priority
          type: integer
          jsonPath: .spec.priority
        - name: Enabled
          type: boolean
          jsonPath: .spec.enabled
        - name: Phase
          type: string
          jsonPath: .status.phase
        - name: Matched
          type: integer
          jsonPath: .status.matchedPods
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp
  scope: Cluster
  names:
    plural: rightsizerpolicies
    singular: rightsizerpolicy
    kind: RightSizerPolicy
    shortNames:
      - rsp
    categories:
      - rightsizer
      - all

---
# RightSizerConfig CRD - Defines global configuration
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  name: rightsizerconfigs.rightsizer.io
  annotations:
    controller-gen.kubebuilder.io/version: v0.14.0
spec:
  group: rightsizer.io
  versions:
    - name: v1alpha1
      served: true
      storage: true
      schema:
        openAPIV3Schema:
          type: object
          description: RightSizerConfig defines the global configuration for the Right Sizer operator
          properties:
            apiVersion:
              type: string
              description: 'APIVersion defines the versioned schema of this representation of an object'
            kind:
              type: string
              description: 'Kind is a string value representing the REST resource this object represents'
            metadata:
              type: object
            spec:
              type: object
              description: RightSizerConfigSpec defines the desired state of RightSizerConfig
              properties:
                global:
                  type: object
                  description: Global configuration settings
                  properties:
                    enabled:
                      type: boolean
                      default: true
                      description: Enable or disable the Right Sizer operator globally
                    dryRun:
                      type: boolean
                      default: false
                      description: Run in dry-run mode (log recommendations without applying)
                    resizeInterval:
                      type: string
                      default: "30s"
                      pattern: "^[0-9]+(s|m|h)$"
                      description: Interval between resize evaluations
                    metricsProvider:
                      type: string
                      enum:
                        - kubernetes
                        - prometheus
                      default: kubernetes
                      description: Source of metrics data
                    prometheusUrl:
                      type: string
                      description: Prometheus endpoint URL (required if metricsProvider is prometheus)
                    logLevel:
                      type: string
                      enum:
                        - debug
                        - info
                        - warn
                        - error
                      default: info
                      description: Logging verbosity level
                defaults:
                  type: object
                  description: Default multipliers and boundaries
                  properties:
                    cpuRequestMultiplier:
                      type: number
                      minimum: 0.1
                      maximum: 10
                      default: 1.2
                      description: Default multiplier for CPU requests
                    memoryRequestMultiplier:
                      type: number
                      minimum: 0.1
                      maximum: 10
                      default: 1.2
                      description: Default multiplier for memory requests
                    cpuLimitMultiplier:
                      type: number
                      minimum: 1
                      maximum: 10
                      default: 2.0
                      description: Default multiplier for CPU limits (relative to requests)
                    memoryLimitMultiplier:
                      type: number
                      minimum: 1
                      maximum: 10
                      default: 2.0
                      description: Default multiplier for memory limits (relative to requests)
                    maxCpuLimit:
                      type: string
                      default: "4000m"
                      pattern: "^[0-9]+(m)?$"
                      description: Maximum allowed CPU limit
                    maxMemoryLimit:
                      type: string
                      default: "8Gi"
                      pattern: "^[0-9]+(Mi|Gi|Ki)?$"
                      description: Maximum allowed memory limit
                    minCpuRequest:
                      type: string
                      default: "10m"
                      pattern: "^[0-9]+(m)?$"
                      description: Minimum allowed CPU request
                    minMemoryRequest:
                      type: string
                      default: "64Mi"
                      pattern: "^[0-9]+(Mi|Gi|Ki)?$"
                      description: Minimum allowed memory request
                features:
                  type: object
                  description: Feature flags
                  properties:
                    enableInPlaceResize:
                      type: boolean
                      default: true
                      description: Enable in-place pod resizing (requires Kubernetes 1.27+)
                    policyBasedSizing:
                      type: boolean
                      default: true
                      description: Enable policy-based resource sizing
                    historicalAnalysis:
                      type: boolean
                      default: true
                      description: Enable historical trend analysis for predictions
                    admissionController:
                      type: boolean
                      default: false
                      description: Enable admission webhook for validation/mutation
                    auditLogging:
                      type: boolean
                      default: true
                      description: Enable comprehensive audit logging
                    customMetrics:
                      type: array
                      items:
                        type: string
                      description: List of custom metrics to consider for sizing
                safety:
                  type: object
                  description: Safety and reliability configuration
                  properties:
                    maxRetries:
                      type: integer
                      minimum: 0
                      maximum: 10
                      default: 3
                      description: Maximum retry attempts for failed operations
                    retryInterval:
                      type: string
                      default: "5s"
                      pattern: "^[0-9]+(s|m|h)$"
                      description: Interval between retry attempts
                    safetyThreshold:
                      type: number
                      minimum: 0
                      maximum: 1
                      default: 0.5
                      description: Maximum allowed resource change percentage (0-1)
                    historyDays:
                      type: integer
                      minimum: 1
                      maximum: 90
                      default: 7
                      description: Number of days to retain historical data
                    circuitBreaker:
                      type: object
                      description: Circuit breaker configuration
                      properties:
                        enabled:
                          type: boolean
                          default: true
                        threshold:
                          type: integer
                          default: 5
                          description: Number of failures before circuit opens
                        timeout:
                          type: string
                          default: "30s"
                          pattern: "^[0-9]+(s|m|h)$"
                          description: Time before attempting to close circuit
                namespaceFilters:
                  type: object
                  description: Namespace filtering configuration
                  properties:
                    include:
                      type: array
                      items:
                        type: string
                      description: List of namespaces to include (empty means all)
                    exclude:
                      type: array
                      items:
                        type: string
                      description: List of namespaces to exclude
                observability:
                  type: object
                  description: Observability configuration
                  properties:
                    metrics:
                      type: object
                      properties:
                        enabled:
                          type: boolean
                          default: true
                        port:
                          type: integer
                          minimum: 1024
                          maximum: 65535
                          default: 9090
                        path:
                          type: string
                          default: "/metrics"
                    healthProbes:
                      type: object
                      properties:
                        livenessPath:
                          type: string
                          default: "/healthz"
                        readinessPath:
                          type: string
                          default: "/readyz"
                        port:
                          type: integer
                          default: 8081
            status:
              type: object
              description: RightSizerConfigStatus defines the observed state of RightSizerConfig
              properties:
                phase:
                  type: string
                  enum:
                    - Active
                    - Updating
                    - Error
                  description: Current state of the configuration
                observedGeneration:
                  type: integer
                  description: Generation of the spec that was last processed
                lastReconciled:
                  type: string
                  format: date-time
                  description: Last time the configuration was reconciled
                policiesLoaded:
                  type: integer
                  description: Number of policies currently loaded
                message:
                  type: string
                  description: Human-readable status message
                conditions:
                  type: array
                  items:
                    type: object
                    required:
                      - type
                      - status
                    properties:
                      type:
                        type: string
                        description: Type of condition
                      status:
                        type: string
                        enum:
                          - "True"
                          - "False"
                          - Unknown
                      lastTransitionTime:
                        type: string
                        format: date-time
                      reason:
                        type: string
                      message:
                        type: string
      subresources:
        status: {}
      additionalPrinterColumns:
        - name: Enabled
          type: boolean
          jsonPath: .spec.global.enabled
        - name: DryRun
          type: boolean
          jsonPath: .spec.global.dryRun
        - name: Phase
          type: string
          jsonPath: .status.phase
        - name: Policies
          type: integer
          jsonPath: .status.policiesLoaded
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp
  scope: Cluster
  names:
    plural: rightsizerconfigs
    singular: rightsizerconfig
    kind: RightSizerConfig
    shortNames:
      - rsc
    categories:
      - rightsizer
      - all
