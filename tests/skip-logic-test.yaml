apiVersion: v1
kind: Namespace
metadata:
  name: rightsizer-test
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: skip-logic-test-config
  namespace: rightsizer-test
data:
  RightSizerConfig: |
    apiVersion: rightsizer.io/v1alpha1
    kind: RightSizerConfig
    metadata:
      name: test-config
      namespace: rightsizer-test
    spec:
      global:
        enabled: true
        dryRun: false
        resizeInterval: "30s"
        metricsProvider: "kubernetes"
        logLevel: "debug"
      defaults:
        cpuRequestMultiplier: 1.2
        memoryRequestMultiplier: 1.2
        cpuLimitMultiplier: 2.0
        memoryLimitMultiplier: 2.0
        maxCpuLimit: "2000m"
        maxMemoryLimit: "2Gi"
        minCpuRequest: "10m"
        minMemoryRequest: "64Mi"
        # Key thresholds for testing
        cpuScaleUpThreshold: 0.8      # Scale up when CPU > 80%
        cpuScaleDownThreshold: 0.3    # Scale down when CPU < 30%
        memoryScaleUpThreshold: 0.8   # Scale up when memory > 80%
        memoryScaleDownThreshold: 0.3 # Scale down when memory < 30%
      features:
        enableInPlaceResize: true
        policyBasedSizing: false
        historicalAnalysis: false
---
# Test Case 1: CPU at 50%, Memory at 20% - Should SKIP resize
apiVersion: apps/v1
kind: Deployment
metadata:
  name: skip-logic-test-case1
  namespace: rightsizer-test
  labels:
    test-case: "skip-resize"
    rightsizer: "enabled"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: skip-test-case1
  template:
    metadata:
      labels:
        app: skip-test-case1
        rightsizer: "enabled"
    spec:
      containers:
      - name: stress-container
        image: polinux/stress
        command: ["stress"]
        args:
          # Use 100m CPU (50% of 200m limit)
          - "--cpu"
          - "1"
          - "--cpu-load"
          - "10"  # 10% of one CPU core = ~100m
          # Use 100Mi memory (20% of 500Mi limit)
          - "--vm"
          - "1"
          - "--vm-bytes"
          - "100M"
          - "--vm-hang"
          - "100"
        resources:
          requests:
            cpu: "100m"
            memory: "256Mi"
          limits:
            cpu: "200m"
            memory: "500Mi"
---
# Test Case 2: CPU at 85%, Memory at 20% - Should RESIZE (CPU scale up)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: skip-logic-test-case2
  namespace: rightsizer-test
  labels:
    test-case: "perform-resize-cpu-up"
    rightsizer: "enabled"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: skip-test-case2
  template:
    metadata:
      labels:
        app: skip-test-case2
        rightsizer: "enabled"
    spec:
      containers:
      - name: stress-container
        image: polinux/stress
        command: ["stress"]
        args:
          # Use 170m CPU (85% of 200m limit)
          - "--cpu"
          - "1"
          - "--cpu-load"
          - "17"  # 17% of one CPU core = ~170m
          # Use 100Mi memory (20% of 500Mi limit)
          - "--vm"
          - "1"
          - "--vm-bytes"
          - "100M"
          - "--vm-hang"
          - "100"
        resources:
          requests:
            cpu: "100m"
            memory: "256Mi"
          limits:
            cpu: "200m"
            memory: "500Mi"
---
# Test Case 3: CPU at 25%, Memory at 25% - Should RESIZE (both scale down)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: skip-logic-test-case3
  namespace: rightsizer-test
  labels:
    test-case: "perform-resize-both-down"
    rightsizer: "enabled"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: skip-test-case3
  template:
    metadata:
      labels:
        app: skip-test-case3
        rightsizer: "enabled"
    spec:
      containers:
      - name: stress-container
        image: polinux/stress
        command: ["stress"]
        args:
          # Use 50m CPU (25% of 200m limit)
          - "--cpu"
          - "1"
          - "--cpu-load"
          - "5"  # 5% of one CPU core = ~50m
          # Use 125Mi memory (25% of 500Mi limit)
          - "--vm"
          - "1"
          - "--vm-bytes"
          - "125M"
          - "--vm-hang"
          - "100"
        resources:
          requests:
            cpu: "100m"
            memory: "256Mi"
          limits:
            cpu: "200m"
            memory: "500Mi"
---
# Test Case 4: CPU at 50%, Memory at 85% - Should RESIZE (memory scale up)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: skip-logic-test-case4
  namespace: rightsizer-test
  labels:
    test-case: "perform-resize-mem-up"
    rightsizer: "enabled"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: skip-test-case4
  template:
    metadata:
      labels:
        app: skip-test-case4
        rightsizer: "enabled"
    spec:
      containers:
      - name: stress-container
        image: polinux/stress
        command: ["stress"]
        args:
          # Use 100m CPU (50% of 200m limit)
          - "--cpu"
          - "1"
          - "--cpu-load"
          - "10"  # 10% of one CPU core = ~100m
          # Use 425Mi memory (85% of 500Mi limit)
          - "--vm"
          - "1"
          - "--vm-bytes"
          - "425M"
          - "--vm-hang"
          - "100"
        resources:
          requests:
            cpu: "100m"
            memory: "256Mi"
          limits:
            cpu: "200m"
            memory: "500Mi"
